@model Vendor.Models.ViewModels.SalesCreateViewModel
@using Newtonsoft.Json;
@using Microsoft.AspNetCore.Identity
@using Vendor.Constants

@inject SignInManager<IdentityUser> SignInManager
@inject UserManager<IdentityUser> UserManager


@{
    ViewData["Title"] = "Create";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@* <h1>New Order</h1> *@

<form asp-action="Create">
    <div class="container">
        <div class="row">
            <div class="col-md-4">

                <div asp-validation-summary="ModelOnly" class="text-danger"></div>
                <div class="form-group">
                    <label asp-for="MenuId" class="control-label"></label>
                    <select asp-for="MenuId" class="form-control" asp-items="ViewBag.MenuId"></select>
                </div>
                <div class="form-group">
                    <label for="Quantity" class="control-label">Quantity</label>
                    <input id="quantity" class="form-control" type="number" name="Quantity" placeholder="1" value="1" />
                </div>
                <div class="form-group">
                    <input type="button" value="Add To Order" id="AddToCart" class="btn btn-primary" />
                </div>

            </div>
            <div class="col-md-2">

            </div>
            <div id="TableDiv" class="col-md-6" style="max-height:250px;overflow-x:auto; margin-top:25px;">

                <table id="Table" class="table">
                    <thead>
                        <tr>
                            <th>
                                Menu
                            </th>
                            <th>
                                Costs
                            </th>
                            <th>
                                Quantity
                            </th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                        </tr>

                    </tbody>
                </table>

            </div>
        </div>

        <div class="row">

        </div>
    </div>

    <div class="container">
        <div class="row">
            <div class="col-md-3">

            </div>
            <div class="col-md-3">

            </div>

            <div id="totalDiv" style="" class="col-md-5">
                <div class="row">

                    <div class="col-md-3">
                        <hr />
                        <h5>Total : <span id="amountSpan">0</span></h5>

                        <span id="tableValidation" class="text-danger"></span>
                    </div>
                    <div class="col-md-9">
                        <hr />
                        @*<div class="form-group">
                                <input type="submit" value="Save" id="" class="btn btn-primary" />
                            </div>*@
                        <div class="form-group">
                            <input type="button" value="Save Order" id="SaveOrder" class="btn btn-primary" />
                        </div>
                        <input type="button" value="Print Page" onclick="print()" />
                    </div>

                </div>

            </div>
        </div>

    </div>
</form>





 <script src="~/lib/jquery/dist/jquery.min.js"></script>

<script>
    var behindMenuItem = @Html.Raw(JsonConvert.SerializeObject(Model.Menu));
    var outletId = @Html.Raw(JsonConvert.SerializeObject(ViewBag.OutletId));
    var userId = @Html.Raw(JsonConvert.SerializeObject(UserManager.GetUserId(User)));
    console.log(outletId);
    console.log("ABove");
    $(document).ready(function () {

        var cart = [];
        var total = 0;
        $("#AddToCart").on("click", function () {
            // 
            //console.log("Adding to Cart");
            //console.log(cart, "Cart Items");
            $("#tableValidation").text("");
            var menuSelection = $("#MenuId").children("option:selected").val();
            if (!mealExist(menuSelection, cart)) {
                var quantity = $("#quantity").val();
                var data = findMeal(menuSelection);
                var updatedData = mealData(data, quantity);
                cart.push(data);
                console.log(updatedData);
               
                total = total + (data["Amount"] * quantity);
                $("#amountSpan").text(total);

                $('#Table > tbody:last-child').append('<tr><td>' + data["Name"] + '</td> <td>' + data["Amount"] + " " + ' (' + data["Amount"] * quantity + ')' + '</td><td>' + data["Quantity"] + '</td></tr>');
                var quantitySelection = $("#quantity").val(1);
                 toastr.success('Item Added to Cart');
                 toastr.display("Hey");
            }
            else {
                console.log("Meal Already Exist");
                $("#tableValidation").text("Meal Already Exist On Order List");
            }

        });



        $("#SaveOrder").on("click", function () {
            console.log("Saving Order");
            var url = $(location).attr('origin') + "/api/SalesAPI/";
            console.log(url);
            $.ajax({
                method: "POST",
                dataType: 'json',
                contentType: 'application/json; charset=utf-8',
                data: JSON.stringify({
                    "Menus": cart,
                    "OutletId": outletId,
                    "CustomerId": 1,
                    "CashierId": userId,
                    "Amount": total
                        }
                ),
                url:url,
                success: function (response) {
                    toastr.success('Transaction Created SUccesfully');
                    console.log("Success");
                    console.log(response);
                },
                failure: function (error) {
                    alert("error");
                    console.log(error);
                    console.log("Failed");
                }
            });
        });
    });
</script>



<script type="text/javascript">

    function print() {

        var prtContent = document.getElementById("TableDiv");
        var WinPrint = window.open('', '', 'left=0,top=50,width=800,height=900,toolbar=0,scrollbars=0,status=0');
        WinPrint.document.write(prtContent.innerHTML);
        WinPrint.document.close();
        WinPrint.focus();
        WinPrint.print();
        WinPrint.close();

    }

    function mealExist(id, cart) {
        var response = false;
        for (let obj of cart) {
            if (obj["Id"] == id) {
                response = true;
                data = obj;
                break;
            }
        }
        return response;
    }

    function findMeal(id) {
        var data = undefined;
        for (let obj of behindMenuItem) {
            if (obj["Id"] == id) {
                data = obj;
                break;
            }
        }
        return data;
    }

    function mealData(meal, quantity) {
        meal.Quantity = quantity;
        return meal;
    }

    function toggleTotal() {
        document.getElementById("totalDiv").style.display = "none";
    }
    function calculator() {

    }
</script>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
}
